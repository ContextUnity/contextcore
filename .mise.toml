# ContextCore — The Kernel of ContextUnity
# Shared type system, gRPC contracts, ContextUnit protocol, security tokens
# Proto files live here — compile_protos.sh regenerates *_pb2.py stubs

[tools]
python = "3.13"
uv = "latest"

[env]
_.file = { path = ".env", tools = true }
PYTHON = "$(mise which python)"

[tasks.sync]
description = "Install all dependencies (dev)"
run = "uv sync --group dev"

[tasks.lint]
description = "Lint + format-check all code (Ruff)"
run = "uv run ruff check src/ tests/ && uv run ruff format --check src/ tests/"

[tasks.format]
description = "Format all code (Ruff)"
run = "uv run ruff check --fix src/ tests/ && uv run ruff format src/ tests/"

[tasks.test]
description = "Run all tests"
run = "uv run pytest tests/ -v"

[tasks.test-unit]
description = "Run unit tests only"
run = "uv run pytest tests/ -v -m unit"

[tasks.test-integration]
description = "Run integration tests only"
run = "uv run pytest tests/ -v -m integration"

[tasks.security]
description = "Run security scan (Bandit)"
run = "uv run bandit -r src/contextcore/"

[tasks.check]
description = "Run all checks (lint + test)"
run = "mise run lint && mise run test"

[tasks.compile-protos]
description = "Compile .proto files → *_pb2.py / *_pb2_grpc.py stubs"
run = "./compile_protos.sh"

[tasks.clean]
description = "Clean cache files and build artifacts"
run = """
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
rm -rf .pytest_cache/ .ruff_cache/ build/ dist/ 2>/dev/null || true
"""

[tasks.build]
description = "Build distribution packages"
run = "uv build"
